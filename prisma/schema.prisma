// datasource and generator
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ---------------------------------------------------------
// 1. User Roles & Permissions
// ---------------------------------------------------------

model Role {
  id          String       @id @default(cuid())
  name        String       @unique
  permissions Permission[]
  users       User[]
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  @@map("roles")
}

model Permission {
  id        String   @id @default(cuid())
  action    String   @unique // e.g., "menu:delete", "order:refund"
  roles     Role[]
  createdAt DateTime @default(now()) @map("created_at")

  @@map("permissions")
}

model User {
  id           String      @id @default(cuid())
  name         String?
  email        String      @unique
  password     String
  roleId       String      @map("role_id")
  role         Role        @relation(fields: [roleId], references: [id])
  restaurantId String?     @map("restaurant_id")
  restaurant   Restaurant? @relation(fields: [restaurantId], references: [id])
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  @@map("users")
}

// ---------------------------------------------------------
// 2. System Settings & Multi-Tenancy
// ---------------------------------------------------------

model Restaurant {
  id           String     @id @default(cuid())
  name         String
  slug         String     @unique
  customDomain String?    @unique @map("custom_domain")
  logo         String?
  description  String?
  status       RestStatus @default(PENDING)
  subscription SubType    @default(FREE)
  subStartDate DateTime?  @map("sub_start_date")
  subEndDate   DateTime?  @map("sub_end_date")
  phone        String?

  // Social Media & Marketing
  facebookUrl  String? @map("facebook_url")
  instagramUrl String? @map("instagram_url")
  tiktokUrl    String? @map("tiktok_url")
  metaPixelId  String? @map("meta_pixel_id")

  branches      Branch[]
  settings      Setting[]
  users         User[]

  // New informative fields
  contactName      String? @map("contact_name")
  contactPhone     String? @map("contact_phone")
  contactEmail     String? @map("contact_email")
  notificationEmail String? @map("notification_email")

  // ðŸ“§ Custom SMTP Settings per Restaurant
  smtpHost        String?   @map("smtp_host")
  smtpPort        Int?      @map("smtp_port")
  smtpUser        String?   @map("smtp_user")
  smtpPass        String?   @map("smtp_pass")
  smtpSecure      Boolean   @default(false) @map("smtp_secure")

  address          String?
  city             String?
  postCode         String? @map("post_code")
  state            String?
  country          String? @default("Pakistan")
  countryCode      String? @default("PK") @map("country_code")
  cuisines         String[] // e.g., ["Bakery", "Fast Food"]
  serviceType      String?  @default("BOTH") @map("service_type") // DELIVERY, PICKUP, BOTH
  lat              Float?
  lng              Float?

  categories    Category[]
  menuItems     MenuItem[]
  ingredients   Ingredient[]
  customers     Customer[]
  discountCodes DiscountCode[]
  riders        Rider[]
  faqItems      FaqItem[]
  cmsPages      CmsPage[]
  promos        PromoBanner[]
  blogPosts     BlogPost[]
  websiteConfig WebsiteConfig?
  subscriptionPrices SubscriptionPrice[]
  subscriptionRequests SubscriptionRequest[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("restaurants")
}

enum RestStatus {
  PENDING
  ACTIVE
  SUSPENDED
}

enum SubType {
  FREE
  BASIC
  PREMIUM
  ENTERPRISE
}

model Branch {
  id      String  @id @default(cuid())
  name    String
  address String
  phone   String?

  // Delivery Logic
  deliveryRadius        Float?   @map("delivery_radius") // in KM
  freeDeliveryThreshold Decimal? @map("free_delivery_threshold") @db.Decimal(10, 2)
  deliveryCharge        Decimal? @map("delivery_charge") @db.Decimal(10, 2)
  deliveryOffTime       String?  @map("delivery_off_time") // e.g., "22:00"
  lat                   Float?
  lng                   Float?

  restaurantId String        @map("restaurant_id")
  restaurant   Restaurant    @relation(fields: [restaurantId], references: [id])
  orders       Order[]
  stocks       Stock[]
  reservations Reservation[]
  tables       Table[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("branches")
}

model Setting {
  id           String     @id @default(cuid())
  key          String // e.g., "currency", "timezone", "theme_mode" (light/dark)
  value        String
  restaurantId String     @map("restaurant_id")
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])

  @@unique([restaurantId, key])
  @@map("settings")
}

// ---------------------------------------------------------
// 3. Menu & Category Management
// ---------------------------------------------------------

model Category {
  id           String     @id @default(cuid())
  name         String
  description  String?
  restaurantId String     @map("restaurant_id")
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])
  menuItems    MenuItem[]
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  @@map("categories")
}

model MenuItem {
  id           String      @id @default(cuid())
  name         String
  description  String?
  price        Decimal     @db.Decimal(10, 2)
  image        String?
  isAvailable  Boolean     @default(true)
  categoryId   String      @map("category_id")
  category     Category    @relation(fields: [categoryId], references: [id])
  restaurantId String      @map("restaurant_id")
  restaurant   Restaurant  @relation(fields: [restaurantId], references: [id])
  variations   Variation[]
  addons       Addon[]
  recipes      Recipe[]
  orderItems   OrderItem[]
  reviews      Review[]
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  @@map("menu_items")
}

model Variation {
  id         String   @id @default(cuid())
  name       String // e.g., Small, Medium, Large
  price      Decimal  @db.Decimal(10, 2)
  menuItemId String   @map("menu_item_id")
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id])

  @@map("variations")
}

model Addon {
  id         String   @id @default(cuid())
  name       String // e.g., Extra Cheese
  price      Decimal  @db.Decimal(10, 2)
  menuItemId String   @map("menu_item_id")
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id])

  @@map("addons")
}

// ---------------------------------------------------------
// 4. Inventory Management
// ---------------------------------------------------------

model Ingredient {
  id           String      @id @default(cuid())
  name         String
  unit         String // e.g., kg, grams, pcs
  restaurantId String      @map("restaurant_id")
  restaurant   Restaurant  @relation(fields: [restaurantId], references: [id])
  recipes      Recipe[]
  stocks       Stock[]
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  @@map("ingredients")
}

model Recipe {
  id           String     @id @default(cuid())
  menuItemId   String     @map("menu_item_id")
  menuItem     MenuItem   @relation(fields: [menuItemId], references: [id])
  ingredientId String     @map("ingredient_id")
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])
  quantity     Float

  @@map("recipes")
}

model Stock {
  id           String     @id @default(cuid())
  quantity     Float
  branchId     String     @map("branch_id")
  branch       Branch     @relation(fields: [branchId], references: [id])
  ingredientId String     @map("ingredient_id")
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])
  updatedAt    DateTime   @updatedAt @map("updated_at")

  @@unique([branchId, ingredientId])
  @@map("stocks")
}

// ---------------------------------------------------------
// 5. Order Management & POS
// ---------------------------------------------------------

model Order {
  id         String      @id @default(cuid())
  orderNo    Int         @default(autoincrement()) @map("order_no")
  status     OrderStatus @default(PENDING)
  type       OrderType
  source     OrderSource @default(POS) @map("source")
  total      Decimal     @db.Decimal(10, 2)
  branchId   String      @map("branch_id")
  branch     Branch      @relation(fields: [branchId], references: [id])
  payment    Payment?
  items      OrderItem[]
  customerId String?     @map("customer_id")
  customer   Customer?   @relation(fields: [customerId], references: [id])
  riderId    String?     @map("rider_id")
  rider      Rider?      @relation(fields: [riderId], references: [id])
  
  // Delivery Details
  deliveryAddress String?   @map("delivery_address")
  deliveryLat     Float?    @map("delivery_lat")
  deliveryLng     Float?    @map("delivery_lng")
  deliveryCharge  Decimal?  @map("delivery_charge") @db.Decimal(10, 2)
  notes           String?
  discountCode    String?   @map("discount_code")

  review     Review?
  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @updatedAt @map("updated_at")

  @@map("orders")
}



enum OrderStatus {
  PENDING
  CONFIRMED
  KITCHEN_READY
  PREPARING
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
}

enum OrderType {
  DINE_IN
  DELIVERY
  PICKUP
}

enum OrderSource {
  WEBSITE
  POS
  MOBILE
}

model OrderItem {
  id         String   @id @default(cuid())
  orderId    String   @map("order_id")
  order      Order    @relation(fields: [orderId], references: [id])
  menuItemId String   @map("menu_item_id")
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id])
  quantity   Int
  price      Decimal  @db.Decimal(10, 2) // Captured at time of order

  @@map("order_items")
}

// ---------------------------------------------------------
// 6. Payment Management
// ---------------------------------------------------------

model Payment {
  id            String        @id @default(cuid())
  amount        Decimal       @db.Decimal(10, 2)
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  transactionId String?       @map("transaction_id")
  orderId       String        @unique @map("order_id")
  order         Order         @relation(fields: [orderId], references: [id])
  createdAt     DateTime      @default(now()) @map("created_at")

  @@map("payments")
}

enum PaymentMethod {
  STRIPE
  PAYPAL
  COD
  CASH
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

// ---------------------------------------------------------
// 7. Customer & Marketing
// ---------------------------------------------------------

model Customer {
  id            String       @id @default(cuid())
  name          String
  email         String?      @unique
  password      String?      // Added for website auth
  phone         String?
  restaurantId  String       @map("restaurant_id")
  restaurant    Restaurant   @relation(fields: [restaurantId], references: [id])
  orders        Order[]
  loyaltyPoints Int          @default(0) @map("loyalty_points")
  loyaltyTrxs   LoyaltyTrx[]
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  @@map("customers")
}

model LoyaltyTrx {
  id         String   @id @default(cuid())
  points     Int
  type       String // EARNED, REDEEMED
  customerId String   @map("customer_id")
  customer   Customer @relation(fields: [customerId], references: [id])
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("loyalty_trxs")
}

model DiscountCode {
  id           String      @id @default(cuid())
  code         String      @unique
  percentage   Float?
  amount       Float?
  isActive     Boolean     @default(true) @map("is_active")
  restaurantId String      @map("restaurant_id")
  restaurant   Restaurant  @relation(fields: [restaurantId], references: [id])
  createdAt    DateTime    @default(now()) @map("created_at")
  expiresAt    DateTime?   @map("expires_at")

  @@map("discount_codes")
}

// ---------------------------------------------------------
// 8. Rider & Notifications
// ---------------------------------------------------------

model Rider {
  id           String      @id @default(cuid())
  name         String
  phone        String?
  status       RiderStatus @default(AVAILABLE)
  restaurantId String      @map("restaurant_id")
  restaurant   Restaurant  @relation(fields: [restaurantId], references: [id])
  orders       Order[]
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")
  @@map("riders")
}

enum RiderStatus {
  AVAILABLE
  BUSY
  OFFLINE
}

model Notification {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  message   String
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("notifications")
}

// ---------------------------------------------------------
// 9. CMS & Support
// ---------------------------------------------------------

model FaqItem {
  id           String     @id @default(cuid())
  question     String
  answer       String
  restaurantId String     @map("restaurant_id")
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  @@map("faq_items")
}

model BlogPost {
  id           String     @id @default(cuid())
  title        String
  snippet      String?
  content      String
  imageUrl     String?
  author       String?
  restaurantId String     @map("restaurant_id")
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])
  publishedAt  DateTime   @default(now()) @map("published_at")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  @@map("blog_posts")
}

model CmsPage {
  id           String     @id @default(cuid())
  title        String
  slug         String
  content      String
  restaurantId String     @map("restaurant_id")
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])

  @@unique([restaurantId, slug])
  @@map("cms_pages")
}

model PromoBanner {
  id           String     @id @default(cuid())
  title        String?
  imageUrl     String
  linkUrl      String?
  isActive     Boolean    @default(true)
  restaurantId String     @map("restaurant_id")
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])

  @@map("promo_banners")
}

model WebsiteConfig {
  id           String     @id @default(cuid())
  restaurantId String     @unique @map("restaurant_id")
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])

  // Theme Settings
  backgroundColor String?  @default("#ffffff") @map("background_color")
  primaryColor    String?  @default("#ff0000") @map("primary_color")

  // Page Configurations (Stored as JSON for maximum flexibility)
  // Format based on documentation-cms.md
  configJson Json @map("config_json")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("website_configs")
}




model Review {
  id         String    @id @default(cuid())
  rating     Int
  comment    String?
  aiEnhanced Boolean   @default(false) @map("ai_enhanced") // For AI generated summaries
  orderId    String    @unique @map("order_id")
  order      Order     @relation(fields: [orderId], references: [id])
  menuItemId String?   @map("menu_item_id")
  menuItem   MenuItem? @relation(fields: [menuItemId], references: [id])
  createdAt  DateTime  @default(now()) @map("created_at")

  @@map("reviews")
}

model Reservation {
  id           String    @id @default(cuid())
  customerName String    @map("customer_name")
  phone        String
  guestCount   Int       @map("guest_count")
  startTime    DateTime  @map("start_time")
  status       ResStatus @default(BOOKED)
  branchId     String    @map("branch_id")
  branch       Branch    @relation(fields: [branchId], references: [id])
  tableId      String?   @map("table_id")
  table        Table?    @relation(fields: [tableId], references: [id])
  createdAt    DateTime  @default(now()) @map("created_at")

  @@map("reservations")
}

enum ResStatus {
  BOOKED
  ARRIVED
  CANCELLED
  COMPLETED
}

// ---------------------------------------------------------
// 12. Table Management
// ---------------------------------------------------------

model Table {
  id           String       @id @default(cuid())
  number       Int
  capacity     Int
  status       TableStatus  @default(AVAILABLE)
  branchId     String       @map("branch_id")
  branch       Branch       @relation(fields: [branchId], references: [id])
  reservations Reservation[]
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  @@unique([branchId, number])
  @@map("tables")
}

enum TableStatus {
  AVAILABLE
  OCCUPIED
  RESERVED
}

// ---------------------------------------------------------
// 13. Subscription Pricing
// ---------------------------------------------------------

model SubscriptionPrice {
  id           String      @id @default(cuid())
  plan         SubType     // FREE, BASIC, PREMIUM, ENTERPRISE
  price        Decimal     @db.Decimal(10, 2)
  billingCycle String      @default("MONTHLY") @map("billing_cycle") // e.g., "MONTHLY", "YEARLY"
  isActive     Boolean     @default(true) @map("is_active")
  restaurantId String      @map("restaurant_id")
  restaurant   Restaurant  @relation(fields: [restaurantId], references: [id])
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  @@unique([restaurantId, plan, billingCycle])
  @@map("subscription_prices")
}

model SubscriptionRequest {
  id           String        @id @default(cuid())
  restaurantId String        @map("restaurant_id")
  restaurant   Restaurant    @relation(fields: [restaurantId], references: [id])
  plan         SubType
  billingCycle String        @map("billing_cycle")
  description  String?
  status       RequestStatus @default(PENDING)
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  @@map("subscription_requests")
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}
